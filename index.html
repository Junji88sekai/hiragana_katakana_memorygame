// ... (中略：HTMLとCSSは前回のコードと同じ)

  <script>
    // ... (中略：word dataとstate variablesは前回のコードと同じ)

    // --- データ定義 (かなモード) の修正 ---
    // kanaMap: ローマ字 -> {グループ, かな文字} の対応表
    const kanaMap = {
      a: { group: 'a', kana: 'あ' }, i: { group: 'a', kana: 'い' }, u: { group: 'a', kana: 'う' }, e: { group: 'a', kana: 'え' }, o: { group: 'a', kana: 'お' },
      ka: { group: 'a', kana: 'か' }, ki: { group: 'a', kana: 'き' }, ku: { group: 'a', kana: 'く' }, ke: { group: 'a', kana: 'け' }, ko: { group: 'a', kana: 'こ' },
      sa: { group: 'sa', kana: 'さ' }, shi: { group: 'sa', kana: 'し' }, su: { group: 'sa', kana: 'す' }, se: { group: 'sa', kana: 'せ' }, so: { group: 'sa', kana: 'そ' },
      ta: { group: 'sa', kana: 'た' }, chi: { group: 'sa', kana: 'ち' }, tsu: { group: 'sa', kana: 'つ' }, te: { group: 'sa', kana: 'て' }, to: { group: 'sa', kana: 'と' },
      na: { group: 'na', kana: 'な' }, ni: { group: 'na', kana: 'に' }, nu: { group: 'na', kana: 'ぬ' }, ne: { group: 'na', kana: 'ね' }, no: { group: 'na', kana: 'の' },
      ha: { group: 'na', kana: 'は' }, hi: { group: 'na', kana: 'ひ' }, fu: { group: 'na', kana: 'ふ' }, he: { group: 'na', kana: 'へ' }, ho: { group: 'na', kana: 'ほ' },
      ma: { group: 'ma', kana: 'ま' }, mi: { group: 'ma', kana: 'み' }, mu: { group: 'ma', kana: 'む' }, me: { group: 'ma', kana: 'め' }, mo: { group: 'ma', kana: 'も' },
      ya: { group: 'ma', kana: 'や' }, yu: { group: 'ma', kana: 'ゆ' }, yo: { group: 'ma', kana: 'よ' },
      ra: { group: 'rawa', kana: 'ら' }, ri: { group: 'rawa', kana: 'り' }, ru: { group: 'rawa', kana: 'る' }, re: { group: 'rawa', kana: 'れ' }, ro: { group: 'rawa', kana: 'ろ' },
      wa: { group: 'rawa', kana: 'わ' }, o_wo: { group: 'rawa', kana: 'を' }, n: { group: 'rawa', kana: 'ん' }
    };
    const allKanas = Object.keys(kanaMap); // ['a', 'i', 'u', ...] ← アイテムはローマ字で管理

    // ... (中略：getMode()関数は前回のコードと同じ)

    function updateCard() {
        // ... (中略：モードと選択グループの取得ロジックは前回のコードと同じ)
        // ... (中略：データソースの選択ロジックは前回のコードと同じ)
        
        // **変更点:** かなモードの場合、フィルタリングロジックの調整
        let filtered = availableItems.filter(item => {
            if (currentMode === "word") {
                 // 単語モード: wordGroupsは配列を持つためsomeを使用
                return itemGroups[item] && itemGroups[item].some(g => selectedGroups.includes(g));
            } else {
                // かなモード: itemGroups (kanaMap) の groupプロパティを参照
                return selectedGroups.includes(itemGroups[item].group);
            }
        });

        filtered = filtered.filter(item => !shownItems.includes(item));

        // ... (中略：完了チェックロジックは前回のコードと同じ)

        // 4. 新しいカードの選択と状態更新
        const randomItem = filtered[Math.floor(Math.random() * filtered.length)];
        shownItems.push(randomItem); 
        currentItem = randomItem; // ここにはローマ字 (例: 'a') が入る
        isFlipped = false; // 常に表面から開始

        renderCard();
        document.getElementById("retry").style.display = "none";
    }

    // カードをレンダリングする関数 (1枚のみ)
    function renderCard() {
        let fileName;
        
        if (currentMode === "word") {
            // 単語モード: "単語名A.png" / "単語名B.png"
            fileName = currentItem;
            
        } else { // かなモード
            // パターンA: 表面=かな文字, 裏面=ローマ字
            if (!isFlipped) {
                // 表面 (かな文字の画像: 例: 'あ.png')
                fileName = kanaMap[currentItem].kana; // 例: 'あ'
            } else {
                // 裏面 (ローマ字の画像: 例: 'a.png')
                fileName = currentItem; // 例: 'a'
            }
        }
        
        // 接尾辞 (ファイル名の拡張子の前): 単語モードではA/Bを使用。かなモードではファイル名自体が異なるため、接尾辞は不要
        const imageSuffix = currentMode === "word" 
                            ? (isFlipped ? `B.png` : `A.png`) 
                            : `.png`;

        const imagePath = `images/${fileName}${imageSuffix}`;

        document.getElementById("cardArea").innerHTML = `
            <img id="card" src="${imagePath}" alt="カード"
                onclick="flipCard()"
                onerror="this.style.border='3px solid red'; console.error('画像が読み込めません: ' + this.src);">
        `;
    }

    // ... (中略：flipCard()とretry()関数は前回のコードと同じ)
    
    // 初期ロード
    updateCard();
  </script>
